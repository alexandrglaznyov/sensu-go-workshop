---
# Description
#   The Sensu InfluxDB Handler is a Sensu Event Handler that sends metrics to
#   the time series database InfluxDB.
#
# Instructions
#   1. Add "influxdb" to the "metric-storage" handler set.
#
#      To create the "metric-storage" handler set, please run:
#
#      $ sensuctl handler create metric-storage --type set --handlers influxdb
#
#      If you already have a handler set called "metric-storage", please run:
#
#      $ sensuctl edit handler metric-storage
#
#      NOTE: the sensuctl edit command will open your default editor; please
#      modify the "handlers" attribute by adding "influxdb".
#
#   2. Configure the following secrets using your preferred Sensu Go Secrets
#      provider:
#
#      - influxdb_url (e.g. "http://127.0.0.1:8086")
#      - influxdb_db (e.g. "sensu")
#      - influxdb_user (e.g. "sensu")
#      - influxdb_password (e.g. "replaceme")
#
#      NOTE: example secret resources using the "env" provider are included in
#      this template; to add your secrets to the Sensu Backend, please modify
#      /etc/default/sensu-backend or /etc/sysconfig/sensu-backend and restart
#      the sensu-backend service.
#
#   3. More configuration options are available for this plugin; please see the
#      plugin documentation for more details.
#
# Documentation
#   - https://github.com/sensu/sensu-influxdb-handler#sensu-influxdb-handler
#   - https://docs.sensu.io/sensu-go/latest/reference/secrets/
#
# Contributors
#   The following individuals have contributed to this configuration template:
#   - @portertech
#   - @nikkiki
#   - @calebhailey
#   - @jspaleta
#   - @nixwiz
type: Handler
api_version: core/v2
metadata:
  name: influxdb
spec:
  type: pipe
  command: >-
    sensu-influxdb-handler -d $INFLUXDB_DB
  timeout: 10
  filters:
  - has_metrics
  runtime_assets:
  - sensu/sensu-influxdb-handler:3.3.0
  secrets:
  - name: INFLUXDB_ADDR
    secret: influxdb_addr
  - name: INFLUXDB_DB
    secret: influxdb_db
  - name: INFLUXDB_USER
    secret: influxdb_user
  - name: INFLUXDB_PASSWORD
    secret: influxdb_password
---
type: Handler
api_version: core/v2
metadata:
  name: influxdb-events
spec:
  type: pipe
  command: >-
    sensu-influxdb-handler -d $INFLUXDB_DB
    --check-status-metric
  timeout: 10    
  filters:
  - is_incident
  handlers: null
  runtime_assets:
  - sensu/sensu-influxdb-handler:3.3.0
  secrets:
  - name: INFLUXDB_ADDR
    secret: influxdb_addr
  - name: INFLUXDB_DB
    secret: influxdb_db
  - name: INFLUXDB_USER
    secret: influxdb_user
  - name: INFLUXDB_PASSWORD
    secret: influxdb_password
---
type: Secret
api_version: secrets/v1
metadata:
  name: influxdb_addr
spec:
  provider: env
  id: INFLUXDB_ADDR
---
type: Secret
api_version: secrets/v1
metadata:
  name: influxdb_db
spec:
  provider: env
  id: INFLUXDB_DB
---
type: Secret
api_version: secrets/v1
metadata:
  name: influxdb_user
spec:
  provider: env
  id: INFLUXDB_USER
---
type: Secret
api_version: secrets/v1
metadata:
  name: influxdb_password
spec:
  provider: env
  id: INFLUXDB_PASSWORD
---
type: Asset
api_version: core/v2
metadata:
  annotations:
    io.sensu.bonsai.api_url: https://bonsai.sensu.io/api/v1/assets/sensu/sensu-influxdb-handler
    io.sensu.bonsai.name: sensu-influxdb-handler
    io.sensu.bonsai.namespace: sensu
    io.sensu.bonsai.tags: ""
    io.sensu.bonsai.tier: Supported
    io.sensu.bonsai.url: https://bonsai.sensu.io/assets/sensu/sensu-influxdb-handler
    io.sensu.bonsai.version: 3.3.0
  name: sensu/sensu-influxdb-handler:3.3.0
  namespace: default
spec:
  builds:
  - filters:
    - entity.system.os == 'windows'
    - entity.system.arch == 'amd64'
    headers: null
    sha512: 3b3dc96840164152a6ea629f44f44faefd6c46f11cfc29377fb6c191631e325aef4c94f1b934ddb3dd3c3b080013938a3b6d7fa2db047b401ad2e0e343c67664
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_windows_amd64.tar.gz
  - filters:
    - entity.system.os == 'darwin'
    - entity.system.arch == '386'
    headers: null
    sha512: 712830e35ec7ffe6c61882c8a217fd7339b93e07da77d12cc7fce8a8d8dffa48484c812b96013f88c92eea5ec2cd5869caf5d08ce4c63ab34e20b3077c900d14
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_darwin_386.tar.gz
  - filters:
    - entity.system.os == 'darwin'
    - entity.system.arch == 'amd64'
    headers: null
    sha512: 0b446baa9e439404162de6f7e44c40b142414d216d5be02c6266bb84ded3fb3e0bb86b63a6fbd3715d64e8eb2868e466b60dff22e8229fe7cc306f23dbb31f9c
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_darwin_amd64.tar.gz
  - filters:
    - entity.system.os == 'linux'
    - entity.system.arch == 'armv7'
    headers: null
    sha512: 4f4a228527e020dc53fd03988feb183267b8345377b330aabf95df443d2be204aee0dcdad557712208364f0add3e6e5d60264cf1a06ef0b273fa5c80d0072b84
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_linux_armv7.tar.gz
  - filters:
    - entity.system.os == 'linux'
    - entity.system.arch == 'arm64'
    headers: null
    sha512: 4029b270bacfadee12cf1572d09dd12e3659e1bf6d5502eb636f5a23eb1a6f4a24a9b8078ca92a3ad75d80ca4ae497a2e0f15e1a730f50f50777e7ba08d6c2e6
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_linux_arm64.tar.gz
  - filters:
    - entity.system.os == 'linux'
    - entity.system.arch == '386'
    headers: null
    sha512: ebacb12580be496b7970c07cd29d78a91a86daf27950865ebc14f29a061142baed906c59d9b8afd9d8b3e24b30bb9c21b1ec3373af1d0d945faaaf1d46ba58c8
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_linux_386.tar.gz
  - filters:
    - entity.system.os == 'linux'
    - entity.system.arch == 'amd64'
    headers: null
    sha512: cc8ec3e29db43238f178ee665ed67dbb7fc55793b20d5a581b30937927bd9e323be99744c66140e49b672c456ecda0bbec04b8b6f7d77db449cf5121001c8122
    url: https://assets.bonsai.sensu.io/a75ef87562d1da7c45349868f7b4dfb5a487a76b/sensu-influxdb-handler_3.3.0_linux_amd64.tar.gz
  filters: null
  headers: null
  